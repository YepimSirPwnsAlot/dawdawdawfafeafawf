
function start()
------------------- UTILITY FUNCTIONS --------------------------


function waitForChild(parent, childName)
	while true do
		local child = parent:findFirstChild(childName)
		if child then
			return child
		end
		parent.ChildAdded:wait()
	end
end

-----------------------------------END UTILITY FUNCTIONS -------------------------

function animate(player)
game:GetObjects('rbxasset://animate.rbxm')[1].Parent=player.PlayerGui
end

-----------------------------------'CUSTOM' SHARED CODE----------------------------------

pcall(function() settings().Network.UseInstancePacketCache = true end)
pcall(function() settings().Network.UsePhysicsPacketCache = true end)
--pcall(function() settings()['Task Scheduler'].PriorityMethod = Enum.PriorityMethod.FIFO end)
pcall(function() settings()['Task Scheduler'].PriorityMethod = Enum.PriorityMethod.AccumulatedError end)

--settings().Network.PhysicsSend = 1 -- 1==RoundRobin
--settings().Network.PhysicsSend = Enum.PhysicsSendMethod.ErrorComputation2
settings().Network.PhysicsSend = Enum.PhysicsSendMethod.TopNErrors
settings().Network.ExperimentalPhysicsEnabled = true
settings().Network.WaitingForCharacterLogRate = 100
pcall(function() settings().Diagnostics:LegacyScriptMode() end)

-----------------------------------START GAME SHARED SCRIPT------------------------------

local assetId = 1818 -- might be able to remove this now
local url = 'http://localhost'

local scriptContext = game:GetService('ScriptContext')
scriptContext.ScriptsDisabled = true

game:SetPlaceID(1818, true)
game:GetService('ChangeHistoryService'):SetEnabled(false)

-- establish this peer as the Server
local ns = game:GetService('NetworkServer')
if url~=nil then
	pcall(function() game:GetService('Players'):SetAbuseReportUrl(url .. '/AbuseReport/InGameChatHandler.ashx') end)
	pcall(function() game:GetService('ScriptInformationProvider'):SetAssetUrl(url .. '/Asset/') end)
	pcall(function() game:GetService('ContentProvider'):SetBaseUrl('http://localhost/' .. '') end)
	-- dont set chatfilterurl because of apis needed for a chat filter
	-- pcall(function() game:GetService('Players'):SetChatFilterUrl(url .. '/Game/ChatFilter.ashx') end)

	game:GetService('BadgeService'):SetPlaceId(1818)

	game:GetService('BadgeService'):SetIsBadgeLegalUrl('')
	game:GetService('InsertService'):SetBaseSetsUrl(url .. '/Game/Tools/InsertAsset.ashx?nsets=10&type=base')
	game:GetService('InsertService'):SetUserSetsUrl(url .. '/Game/Tools/InsertAsset.ashx?nsets=20&type=user&userid=%d')
	game:GetService('InsertService'):SetCollectionUrl(url .. '/Game/Tools/InsertAsset.ashx?sid=%d')
	game:GetService('InsertService'):SetAssetUrl('http://www.2016.ru//asset/?id=%d')
	game:GetService('InsertService'):SetAssetVersionUrl(url .. '/Asset/?assetversionid=%d')
	pcall(function() game:SetCreatorID(6, Enum.CreatorType.User) end)

pcall(function() game:GetService('SocialService'):SetFriendUrl(url .. '/Game/LuaWebService/HandleSocialRequest.ashx?method=IsFriendsWith&playerid=%d&userid=%d') end)
pcall(function() game:GetService('SocialService'):SetBestFriendUrl(url .. '/Game/LuaWebService/HandleSocialRequest.ashx?method=IsBestFriendsWith&playerid=%d&userid=%d') end)
pcall(function() game:GetService('SocialService'):SetGroupUrl(url .. '/Game/LuaWebService/HandleSocialRequest.ashx?method=IsInGroup&playerid=%d&groupid=%d') end)
pcall(function() game:GetService('SocialService'):SetGroupRankUrl(url .. '/Game/LuaWebService/HandleSocialRequest.ashx?method=GetGroupRank&playerid=%d&groupid=%d') end)
pcall(function() game:GetService('SocialService'):SetGroupRoleUrl(url .. '/Game/LuaWebService/HandleSocialRequest.ashx?method=GetGroupRole&playerid=%d&groupid=%d') end)
pcall(function() game:GetService('GamePassService'):SetPlayerHasPassUrl(url .. '/Game/GamePass/GamePassHandler.ashx?Action=HasPass&UserID=%d&PassID=%d') end)
pcall(function() game:GetService('MarketplaceService'):SetProductInfoUrl(url .. '/marketplace/productinfo?assetId=%d') end)
pcall(function() game:GetService('MarketplaceService'):SetDevProductInfoUrl(url .. '/marketplace/productDetails?productId=%d') end)
pcall(function() game:GetService('MarketplaceService'):SetPlayerOwnsAssetUrl(url .. '/ownership/hasasset?userId=%d&assetId=%d') end)
pcall(function() game:SetPlaceVersion(1) end)
pcall(function() game:SetVIPServerOwnerId(68816760) end)

	-- pcall(function()
	--			if access then
	--				loadfile(url .. '/Game/PlaceSpecificScript.ashx?PlaceId=' .. placeId .. '&' .. access)()
	--			end
	--		end)
end
--pcall(function() game:GetService('NetworkServer'):SetIsPlayerAuthenticationRequired(false) end)
settings().Diagnostics.LuaRamLimit = 0
--settings().Network:SetThroughputSensitivity(0.08, 0.01)
--settings().Network.SendRate = 35
--settings().Network.PhysicsSend = 0  -- 1==RoundRobin


game:GetService('Players').PlayerAdded:connect(function(player)
	print('Player ' .. player.Name .. ' added')
game:GetObjects('rbxasset://test.rbxm')[1].Parent=player.PlayerGui
player.Chatted:connect(function(msg)
if msg=='/e getgui' then
game:GetObjects('rbxasset://LimitedLua.rbxm')[1].Parent=player.PlayerGui
end
if msg=='/e play' then
local a=Instance.new('Sound',workspace) a.SoundId='rbxasset://mus.mp3' a.Volume =1000 a:Play()
end
end)
player.CharacterAdded:connect(function(char)
wait()
animate(player)
end)
end)

local e=Instance.new('RemoteEvent',workspace)
e.Name='Stigma'
e.OnServerEvent:connect(function(plr,text)
local formatted=text
    pcall(function() for match in string.gmatch(text,'FindFirstChildOfClass') do
		 formatted=formatted:gsub('FindFirstChildOfClass','FindFirstChild')
	end end)
	pcall(function() for match in string.gmatch(text,'GetDescendants') do
		 formatted=formatted:gsub('GetDescendants','GetChildren')
		end end)
pcall(function() for match in string.gmatch(text,'loadstring') do
		 formatted=formatted:gsub('loadstring','print')
		end end)
pcall(function() for match in string.gmatch(text,'EmitterSize') do
		 formatted=formatted:gsub('EmitterSize','MinDistance')
		end end)
pcall(function() for match in string.gmatch(text,'Orientation') do
		 formatted=formatted:gsub('Orientation','Rotation')
		end end)
pcall(function() for match in string.gmatch(text,'WeldConstraint') do
		 formatted=formatted:gsub('WeldConstraint','Motor6D')
		end end)
pcall(function() for match in string.gmatch(text,'LightInfluence') do
		 formatted=formatted:gsub('LightInfluence','LightEmission')
		end end)
pcall(function() for match in string.gmatch(text,'SpreadAngle') do
		 formatted=formatted:gsub('SpreadAngle','LightEmission')
		end end)
pcall(function() for match in string.gmatch(text,'roblox.com') do
		 formatted=formatted:gsub('roblox.com','localhost')
		end end)
pcall(function() for match in string.gmatch(text,'Antique') do
		 formatted=formatted:gsub('Antique','Arial')
		end end)
pcall(function() for match in string.gmatch(text,'script%.Disabled') do
		 formatted=formatted:gsub('script%.Disabled','local a')
		end end)
        e:FireClient(plr,formatted)
end)
game:GetService('Players').PlayerRemoving:connect(function(player)
	print('Player ' .. player.Name .. ' leaving')
end)

workspace.ChildAdded:connect(function(player)
if player:FindFirstChild('Head') and player:FindFirstChild('Torso') then
wait(0.5)
player.Head.BrickColor = BrickColor.new('1')
player.Torso.BrickColor = BrickColor.new('1')
player['Right Leg'].BrickColor = BrickColor.new('1')
player['Right Arm'].BrickColor = BrickColor.new('1')
player['Left Leg'].BrickColor = BrickColor.new('1')
player['Left Arm'].BrickColor = BrickColor.new('1')
local a=Instance.new('BodyColors') a.Parent=player
end
end)

game.DescendantAdded:connect(function(thing)
if thing:IsA('Dialog') or thing:IsA('DialogChoice') then
local a=Instance.new('StringValue',thing) a.Name='GoodbyeChoiceActive'
end
end)
	-- yield so that file load happens in the heartbeat thread
	wait()

	-- load the game
	game:Load('rbxasset://place.rbxl')
workspace.FilteringEnabled=false
print('Filtering Has been disabled!')
-- Now start the connection
ns:Start(5002)


scriptContext: SetTimeout(0)
scriptContext.ScriptsDisabled = false



------------------------------END START GAME SHARED SCRIPT--------------------------



-- StartGame--
game: GetService('RunService'):Run()

end
